defmodule ChartPatternDetectionTest do
  use ExUnit.Case
  alias ChartPatternDetection, as: CPD
  alias Decimal, as: D
  alias Enum, as: E

  @contrived_chart [
    %{l: D.new("1.0"), h: D.new("1.1"), t: 1000},
    %{l: D.new("0.5"), h: D.new("1.0"), t: 1060},
    %{l: D.new("0.6"), h: D.new("1.0"), t: 1120},
    %{l: D.new("0.7"), h: D.new("1.5"), t: 1180},
    %{l: D.new("0.6"), h: D.new("1.0"), t: 1240},
    %{l: D.new("0.5"), h: D.new("1.0"), t: 1300},
    %{l: D.new("0.6"), h: D.new("0.9"), t: 1360},
    %{l: D.new("0.7"), h: D.new("1.5"), t: 1420},
    %{l: D.new("0.5"), h: D.new("1.0"), t: 1480},
    %{l: D.new("0.6"), h: D.new("0.9"), t: 1540}
  ]

  @contrived_result [
    {:lo, %{l: D.new("0.5"), h: D.new("1.0"), t: 1480}},
    {:hi, %{l: D.new("0.7"), h: D.new("1.5"), t: 1420}},
    {:lo, %{l: D.new("0.5"), h: D.new("1.0"), t: 1300}},
    {:hi, %{l: D.new("0.7"), h: D.new("1.5"), t: 1180}},
    {:lo, %{l: D.new("0.5"), h: D.new("1.0"), t: 1060}}
  ]

  @contrived_result_normalized [
    {:lo, %{h: D.new("0.5"), l: D.new("0"), t: D.new("1")}},
    {:hi, %{h: D.new("1"), l: D.new("0.2"), t: D.new("0.86")}},
    {:lo, %{h: D.new("0.5"), l: D.new("0"), t: D.new("0.57")}},
    {:hi, %{h: D.new("1"), l: D.new("0.2"), t: D.new("0.28")}},
    {:lo, %{h: D.new("0.5"), l: D.new("0"), t: D.new("0.0")}}
  ]

  @trend_chart [
                 %{o: "134.95", c: "136.28", h: "136.75", l: "133.22", t: 1_570_075_200},
                 %{o: "136.75", c: "138.12", h: "138.25", l: "136.42", t: 1_570_161_600},
                 %{o: "137.14", c: "137.12", h: "138.18", l: "137.02", t: 1_570_420_800},
                 %{o: "137.08", c: "135.67", h: "137.76", l: "135.62", t: 1_570_507_200},
                 %{o: "137.46", c: "138.24", h: "138.70", l: "136.97", t: 1_570_593_600},
                 %{o: "138.49", c: "139.10", h: "139.67", l: "138.25", t: 1_570_680_000},
                 %{o: "140.12", c: "139.68", h: "141.03", l: "139.50", t: 1_570_766_400},
                 %{o: "139.69", c: "139.55", h: "140.29", l: "139.52", t: 1_571_025_600},
                 %{o: "140.06", c: "141.58", h: "141.79", l: "139.81", t: 1_571_112_000},
                 %{o: "140.79", c: "140.41", h: "140.99", l: "139.53", t: 1_571_198_400},
                 %{o: "140.95", c: "139.69", h: "141.42", l: "139.02", t: 1_571_284_800},
                 %{o: "139.76", c: "137.41", h: "140.00", l: "136.56", t: 1_571_371_200},
                 %{o: "138.45", c: "138.43", h: "138.50", l: "137.01", t: 1_571_630_400},
                 %{o: "138.97", c: "136.37", h: "140.01", l: "136.26", t: 1_571_716_800},
                 %{o: "136.88", c: "137.24", h: "137.45", l: "135.61", t: 1_571_803_200},
                 %{o: "139.39", c: "139.94", h: "140.42", l: "138.67", t: 1_571_889_600},
                 %{o: "139.34", c: "140.73", h: "141.14", l: "139.20", t: 1_571_976_000},
                 %{o: "144.40", c: "144.19", h: "145.67", l: "143.51", t: 1_572_235_200},
                 %{o: "144.08", c: "142.83", h: "144.50", l: "142.65", t: 1_572_321_600},
                 %{o: "143.52", c: "144.61", h: "145.00", l: "142.79", t: 1_572_408_000},
                 %{o: "144.90", c: "143.37", h: "144.93", l: "142.99", t: 1_572_494_400},
                 %{o: "144.26", c: "143.72", h: "144.42", l: "142.97", t: 1_572_580_800},
                 %{o: "144.83", c: "144.55", h: "145.00", l: "144.16", t: 1_572_843_600},
                 %{o: "144.97", c: "144.46", h: "145.02", l: "143.91", t: 1_572_930_000},
                 %{o: "144.37", c: "144.06", h: "144.52", l: "143.20", t: 1_573_016_400},
                 %{o: "143.84", c: "144.26", h: "144.88", l: "143.77", t: 1_573_102_800},
                 %{o: "143.98", c: "145.96", h: "145.99", l: "143.76", t: 1_573_189_200},
                 %{o: "145.34", c: "146.11", h: "146.42", l: "144.73", t: 1_573_448_400},
                 %{o: "146.28", c: "147.07", h: "147.57", l: "146.06", t: 1_573_534_800},
                 %{o: "146.74", c: "147.31", h: "147.46", l: "146.28", t: 1_573_621_200},
                 %{o: "147.02", c: "148.06", h: "148.41", l: "147.00", t: 1_573_707_600},
                 %{o: "148.93", c: "149.97", h: "149.99", l: "148.27", t: 1_573_794_000},
                 %{o: "150.07", c: "150.34", h: "150.55", l: "148.98", t: 1_574_053_200},
                 %{o: "150.88", c: "150.39", h: "151.33", l: "150.20", t: 1_574_139_600},
                 %{o: "150.31", c: "149.62", h: "150.84", l: "148.46", t: 1_574_226_000},
                 %{o: "149.40", c: "149.48", h: "149.80", l: "148.50", t: 1_574_312_400},
                 %{o: "150.07", c: "149.59", h: "150.30", l: "148.82", t: 1_574_398_800},
                 %{o: "150.00", c: "151.23", h: "151.35", l: "149.92", t: 1_574_658_000},
                 %{o: "151.36", c: "152.03", h: "152.42", l: "151.32", t: 1_574_744_400},
                 %{o: "152.33", c: "152.32", h: "152.50", l: "151.52", t: 1_574_830_800},
                 %{o: "152.10", c: "151.38", h: "152.30", l: "151.28", t: 1_575_003_600},
                 %{o: "151.81", c: "149.55", h: "151.83", l: "148.32", t: 1_575_262_800},
                 %{o: "147.49", c: "149.31", h: "149.43", l: "146.65", t: 1_575_349_200},
                 %{o: "150.14", c: "149.85", h: "150.18", l: "149.20", t: 1_575_435_600},
                 %{o: "150.05", c: "149.93", h: "150.32", l: "149.48", t: 1_575_522_000},
                 %{o: "150.99", c: "151.75", h: "151.87", l: "150.27", t: 1_575_608_400},
                 %{o: "151.07", c: "151.36", h: "152.21", l: "150.91", t: 1_575_867_600},
                 %{o: "151.29", c: "151.13", h: "151.89", l: "150.77", t: 1_575_954_000},
                 %{o: "151.54", c: "151.70", h: "151.87", l: "150.33", t: 1_576_040_400},
                 %{o: "151.65", c: "153.24", h: "153.44", l: "151.02", t: 1_576_126_800},
                 %{o: "153.00", c: "154.53", h: "154.89", l: "152.83", t: 1_576_213_200},
                 %{o: "155.11", c: "155.53", h: "155.90", l: "154.82", t: 1_576_472_400},
                 %{o: "155.45", c: "154.69", h: "155.71", l: "154.45", t: 1_576_558_800},
                 %{o: "154.30", c: "154.37", h: "155.48", l: "154.18", t: 1_576_645_200},
                 %{o: "154.00", c: "155.71", h: "155.77", l: "153.75", t: 1_576_731_600},
                 %{o: "157.35", c: "157.41", h: "158.49", l: "156.29", t: 1_576_818_000},
                 %{o: "158.12", c: "157.41", h: "158.12", l: "157.27", t: 1_577_077_200},
                 %{o: "157.48", c: "157.38", h: "157.71", l: "157.12", t: 1_577_163_600},
                 %{o: "157.56", c: "158.67", h: "158.73", l: "157.40", t: 1_577_336_400},
                 %{o: "159.45", c: "158.96", h: "159.55", l: "158.22", t: 1_577_422_800},
                 %{o: "158.99", c: "157.59", h: "159.02", l: "156.73", t: 1_577_682_000},
                 %{o: "156.77", c: "157.70", h: "157.77", l: "156.45", t: 1_577_768_400},
                 %{o: "158.78", c: "160.62", h: "160.73", l: "158.33", t: 1_577_941_200},
                 %{o: "158.32", c: "158.62", h: "159.95", l: "158.06", t: 1_578_027_600},
                 %{o: "157.08", c: "159.03", h: "159.10", l: "156.51", t: 1_578_286_800},
                 %{o: "159.32", c: "157.58", h: "159.67", l: "157.32", t: 1_578_373_200},
                 %{o: "158.93", c: "160.09", h: "160.80", l: "157.95", t: 1_578_459_600},
                 %{o: "161.84", c: "162.09", h: "162.22", l: "161.03", t: 1_578_546_000},
                 %{o: "162.82", c: "161.34", h: "163.22", l: "161.18", t: 1_578_632_400},
                 %{o: "161.76", c: "163.28", h: "163.31", l: "161.26", t: 1_578_891_600},
                 %{o: "163.39", c: "162.13", h: "163.60", l: "161.72", t: 1_578_978_000},
                 %{o: "162.62", c: "163.18", h: "163.94", l: "162.57", t: 1_579_064_400},
                 %{o: "164.35", c: "166.17", h: "166.24", l: "164.03", t: 1_579_150_800},
                 %{o: "167.42", c: "167.10", h: "167.47", l: "165.43", t: 1_579_237_200},
                 %{o: "166.68", c: "166.50", h: "168.19", l: "166.43", t: 1_579_582_800},
                 %{o: "167.40", c: "165.70", h: "167.49", l: "165.68", t: 1_579_669_200},
                 %{o: "166.19", c: "166.72", h: "166.80", l: "165.27", t: 1_579_755_600},
                 %{o: "167.51", c: "165.04", h: "167.53", l: "164.45", t: 1_579_842_000},
                 %{o: "161.15", c: "162.28", h: "163.38", l: "160.20", t: 1_580_101_200}
               ]
               |> Enum.map(fn b = %{h: h, l: l, o: o, c: c} ->
                 Map.merge(b, %{h: D.new(h), l: D.new(l), o: D.new(o), c: D.new(c)})
               end)

  describe "ChartPatternDetection" do
    test "get_subsets/2" do
      {:ok, subsets} = CPD.get_subsets([1, 2, 3, 4, 5], 3)

      assert subsets == [[1, 2, 3, 4, 5], [1, 2, 3, 4], [1, 2, 3]]
    end

    test "get_reversals/1" do
      D.Context.with(%D.Context{precision: 2, rounding: :half_even}, fn ->
        result = CPD.reversals(@contrived_chart)
        assert result == @contrived_result
        assert CPD.normalize(result) == @contrived_result_normalized
      end)
    end

    test "trend" do
      D.Context.with(%D.Context{precision: 4, rounding: :half_even}, fn ->
        tests = [
          fn l -> length(l) > 40 end,
          fn l ->
            case {E.at(l, 0), E.at(l, -1)} do
              {{:lo, %{l: a}}, {:lo, %{l: b}}} -> D.lt?(a, "0.01") and D.gt?(b, "0.5")
              _ -> false
            end
          end
        ]

        normalized_subsets =
          @trend_chart
          |> CPD.reversals()
          |> CPD.get_subsets(15)
          |> (fn {:ok, result} -> result end).()
          |> E.map(fn z -> z |> CPD.normalize() |> CPD.detect(tests) end)

        IO.inspect(normalized_subsets)
      end)
    end
  end
end

defmodule OhlcPatternDetectionTest do
  use ExUnit.Case
  alias OhlcPatternDetection.Reversals
  alias Decimal, as: D

  @fixture1 [
    %{l: D.new("1.0"), h: D.new("1.1"), t: 1000},
    %{l: D.new("0.5"), h: D.new("1.0"), t: 1060},
    %{l: D.new("0.6"), h: D.new("1.0"), t: 1120},
    %{l: D.new("0.7"), h: D.new("1.5"), t: 1180},
    %{l: D.new("0.6"), h: D.new("1.0"), t: 1240},
    %{l: D.new("0.5"), h: D.new("1.0"), t: 1300},
    %{l: D.new("0.6"), h: D.new("0.9"), t: 1360},
    %{l: D.new("0.7"), h: D.new("1.5"), t: 1420},
    %{l: D.new("0.5"), h: D.new("1.0"), t: 1480},
    %{l: D.new("0.6"), h: D.new("0.9"), t: 1540}
  ]

  @expected1 [
    {:lo, %{l: D.new("0.5"), h: D.new("1.0"), t: 1480}},
    {:hi, %{l: D.new("0.7"), h: D.new("1.5"), t: 1420}},
    {:lo, %{l: D.new("0.5"), h: D.new("1.0"), t: 1300}},
    {:hi, %{l: D.new("0.7"), h: D.new("1.5"), t: 1180}},
    {:lo, %{l: D.new("0.5"), h: D.new("1.0"), t: 1060}}
  ]

  @expected2 [
    {:lo, %{h: D.new("0.5"), l: D.new("0"), t: D.new("1")}},
    {:hi, %{h: D.new("1"), l: D.new("0.2"), t: D.new("0.86")}},
    {:lo, %{h: D.new("0.5"), l: D.new("0"), t: D.new("0.57")}},
    {:hi, %{h: D.new("1"), l: D.new("0.2"), t: D.new("0.28")}},
    {:lo, %{h: D.new("0.5"), l: D.new("0"), t: D.new("0.0")}}
  ]

  @trend_chart [
    %{o: "134.95", c: "136.28", h: "136.75", l: "133.22", t: 1_570_075_200, v: 25_167_437},
    %{o: "136.75", c: "138.12", h: "138.25", l: "136.42", t: 1_570_161_600, v: 23_063_073},
    %{o: "137.14", c: "137.12", h: "138.18", l: "137.02", t: 1_570_420_800, v: 15_727_014},
    %{o: "137.08", c: "135.67", h: "137.76", l: "135.62", t: 1_570_507_200, v: 25_949_458},
    %{o: "137.46", c: "138.24", h: "138.70", l: "136.97", t: 1_570_593_600, v: 20_058_091},
    %{o: "138.49", c: "139.10", h: "139.67", l: "138.25", t: 1_570_680_000, v: 18_358_347},
    %{o: "140.12", c: "139.68", h: "141.03", l: "139.50", t: 1_570_766_400, v: 25_532_284},
    %{o: "139.69", c: "139.55", h: "140.29", l: "139.52", t: 1_571_025_600, v: 13_571_325},
    %{o: "140.06", c: "141.58", h: "141.79", l: "139.81", t: 1_571_112_000, v: 19_873_773},
    %{o: "140.79", c: "140.41", h: "140.99", l: "139.53", t: 1_571_198_400, v: 20_824_239},
    %{o: "140.95", c: "139.69", h: "141.42", l: "139.02", t: 1_571_284_800, v: 22_083_259},
    %{o: "139.76", c: "137.41", h: "140.00", l: "136.56", t: 1_571_371_200, v: 32_261_671},
    %{o: "138.45", c: "138.43", h: "138.50", l: "137.01", t: 1_571_630_400, v: 20_686_954},
    %{o: "138.97", c: "136.37", h: "140.01", l: "136.26", t: 1_571_716_800, v: 27_794_188},
    %{o: "136.88", c: "137.24", h: "137.45", l: "135.61", t: 1_571_803_200, v: 30_396_354},
    %{o: "139.39", c: "139.94", h: "140.42", l: "138.67", t: 1_571_889_600, v: 37_201_721},
    %{o: "139.34", c: "140.73", h: "141.14", l: "139.20", t: 1_571_976_000, v: 25_199_205},
    %{o: "144.40", c: "144.19", h: "145.67", l: "143.51", t: 1_572_235_200, v: 35_233_630},
    %{o: "144.08", c: "142.83", h: "144.50", l: "142.65", t: 1_572_321_600, v: 19_773_775},
    %{o: "143.52", c: "144.61", h: "145.00", l: "142.79", t: 1_572_408_000, v: 18_459_586},
    %{o: "144.90", c: "143.37", h: "144.93", l: "142.99", t: 1_572_494_400, v: 24_489_807},
    %{o: "144.26", c: "143.72", h: "144.42", l: "142.97", t: 1_572_580_800, v: 33_106_511},
    %{o: "144.83", c: "144.55", h: "145.00", l: "144.16", t: 1_572_843_600, v: 16_865_833},
    %{o: "144.97", c: "144.46", h: "145.02", l: "143.91", t: 1_572_930_000, v: 18_217_272},
    %{o: "144.37", c: "144.06", h: "144.52", l: "143.20", t: 1_573_016_400, v: 16_564_051},
    %{o: "143.84", c: "144.26", h: "144.88", l: "143.77", t: 1_573_102_800, v: 17_767_786},
    %{o: "143.98", c: "145.96", h: "145.99", l: "143.76", t: 1_573_189_200, v: 16_726_173},
    %{o: "145.34", c: "146.11", h: "146.42", l: "144.73", t: 1_573_448_400, v: 14_350_512},
    %{o: "146.28", c: "147.07", h: "147.57", l: "146.06", t: 1_573_534_800, v: 18_051_270},
    %{o: "146.74", c: "147.31", h: "147.46", l: "146.28", t: 1_573_621_200, v: 17_432_232},
    %{o: "147.02", c: "148.06", h: "148.41", l: "147.00", t: 1_573_707_600, v: 19_708_417},
    %{o: "148.93", c: "149.97", h: "149.99", l: "148.27", t: 1_573_794_000, v: 23_474_017},
    %{o: "150.07", c: "150.34", h: "150.55", l: "148.98", t: 1_574_053_200, v: 21_531_326},
    %{o: "150.88", c: "150.39", h: "151.33", l: "150.20", t: 1_574_139_600, v: 23_591_855},
    %{o: "150.31", c: "149.62", h: "150.84", l: "148.46", t: 1_574_226_000, v: 25_535_102},
    %{o: "149.40", c: "149.48", h: "149.80", l: "148.50", t: 1_574_312_400, v: 18_429_064},
    %{o: "150.07", c: "149.59", h: "150.30", l: "148.82", t: 1_574_398_800, v: 15_895_044},
    %{o: "150.00", c: "151.23", h: "151.35", l: "149.92", t: 1_574_658_000, v: 22_416_970},
    %{o: "151.36", c: "152.03", h: "152.42", l: "151.32", t: 1_574_744_400, v: 24_614_811},
    %{o: "152.33", c: "152.32", h: "152.50", l: "151.52", t: 1_574_830_800, v: 15_173_544},
    %{o: "152.10", c: "151.38", h: "152.30", l: "151.28", t: 1_575_003_600, v: 11_977_300},
    %{o: "151.81", c: "149.55", h: "151.83", l: "148.32", t: 1_575_262_800, v: 27_300_284},
    %{o: "147.49", c: "149.31", h: "149.43", l: "146.65", t: 1_575_349_200, v: 25_089_204},
    %{o: "150.14", c: "149.85", h: "150.18", l: "149.20", t: 1_575_435_600, v: 17_385_376},
    %{o: "150.05", c: "149.93", h: "150.32", l: "149.48", t: 1_575_522_000, v: 17_867_270},
    %{o: "150.99", c: "151.75", h: "151.87", l: "150.27", t: 1_575_608_400, v: 16_329_431},
    %{o: "151.07", c: "151.36", h: "152.21", l: "150.91", t: 1_575_867_600, v: 15_333_953},
    %{o: "151.29", c: "151.13", h: "151.89", l: "150.77", t: 1_575_954_000, v: 16_474_874},
    %{o: "151.54", c: "151.70", h: "151.87", l: "150.33", t: 1_576_040_400, v: 18_851_465},
    %{o: "151.65", c: "153.24", h: "153.44", l: "151.02", t: 1_576_126_800, v: 24_527_655},
    %{o: "153.00", c: "154.53", h: "154.89", l: "152.83", t: 1_576_213_200, v: 23_842_672},
    %{o: "155.11", c: "155.53", h: "155.90", l: "154.82", t: 1_576_472_400, v: 24_070_454},
    %{o: "155.45", c: "154.69", h: "155.71", l: "154.45", t: 1_576_558_800, v: 25_408_042},
    %{o: "154.30", c: "154.37", h: "155.48", l: "154.18", t: 1_576_645_200, v: 22_517_194},
    %{o: "154.00", c: "155.71", h: "155.77", l: "153.75", t: 1_576_731_600, v: 24_934_870},
    %{o: "157.35", c: "157.41", h: "158.49", l: "156.29", t: 1_576_818_000, v: 53_474_163},
    %{o: "158.12", c: "157.41", h: "158.12", l: "157.27", t: 1_577_077_200, v: 17_715_490},
    %{o: "157.48", c: "157.38", h: "157.71", l: "157.12", t: 1_577_163_600, v: 8_989_150},
    %{o: "157.56", c: "158.67", h: "158.73", l: "157.40", t: 1_577_336_400, v: 14_517_173},
    %{o: "159.45", c: "158.96", h: "159.55", l: "158.22", t: 1_577_422_800, v: 18_410_680},
    %{o: "158.99", c: "157.59", h: "159.02", l: "156.73", t: 1_577_682_000, v: 16_344_227},
    %{o: "156.77", c: "157.70", h: "157.77", l: "156.45", t: 1_577_768_400, v: 18_366_492},
    %{o: "158.78", c: "160.62", h: "160.73", l: "158.33", t: 1_577_941_200, v: 22_613_604},
    %{o: "158.32", c: "158.62", h: "159.95", l: "158.06", t: 1_578_027_600, v: 21_109_108},
    %{o: "157.08", c: "159.03", h: "159.10", l: "156.51", t: 1_578_286_800, v: 19_501_568},
    %{o: "159.32", c: "157.58", h: "159.67", l: "157.32", t: 1_578_373_200, v: 21_610_184},
    %{o: "158.93", c: "160.09", h: "160.80", l: "157.95", t: 1_578_459_600, v: 27_727_737},
    %{o: "161.84", c: "162.09", h: "162.22", l: "161.03", t: 1_578_546_000, v: 21_362_967},
    %{o: "162.82", c: "161.34", h: "163.22", l: "161.18", t: 1_578_632_400, v: 20_722_511},
    %{o: "161.76", c: "163.28", h: "163.31", l: "161.26", t: 1_578_891_600, v: 20_974_619},
    %{o: "163.39", c: "162.13", h: "163.60", l: "161.72", t: 1_578_978_000, v: 23_431_752},
    %{o: "162.62", c: "163.18", h: "163.94", l: "162.57", t: 1_579_064_400, v: 21_382_800},
    %{o: "164.35", c: "166.17", h: "166.24", l: "164.03", t: 1_579_150_800, v: 23_750_221},
    %{o: "167.42", c: "167.10", h: "167.47", l: "165.43", t: 1_579_237_200, v: 33_466_833},
    %{o: "166.68", c: "166.50", h: "168.19", l: "166.43", t: 1_579_582_800, v: 29_488_803},
    %{o: "167.40", c: "165.70", h: "167.49", l: "165.68", t: 1_579_669_200, v: 24_104_012},
    %{o: "166.19", c: "166.72", h: "166.80", l: "165.27", t: 1_579_755_600, v: 19_629_241},
    %{o: "167.51", c: "165.04", h: "167.53", l: "164.45", t: 1_579_842_000, v: 24_892_325},
    %{o: "161.15", c: "162.28", h: "163.38", l: "160.20", t: 1_580_101_200, v: 31_929_654}
  ]

  describe "OhlcPatternDetection" do
    test "get_reversals/1" do
      D.Context.with(%D.Context{precision: 2, rounding: :half_even}, fn ->
        result = Reversals.get(@fixture1)
        assert result == @expected1
        assert Reversals.normalize(result) == @expected2
      end)
    end

    test "trend" do
      D.Context.with(%D.Context{precision: 4, rounding: :half_even}, fn ->
        trend_chart =
          Enum.map(@trend_chart, fn b = %{h: h, l: l} ->
            Map.merge(b, %{h: D.new(h), l: D.new(l)})
          end)

        result = Reversals.get(trend_chart) |> Reversals.normalize()
        IO.inspect(result)
      end)
    end
  end
end
